# XP extension for Visual Studio Code

VSCode XP - это расширение для [VsCode](https://code.visualstudio.com/) и [VsCodium](https://vscodium.com/) для просмотра, создания, редактирования и тестирования правил на языке [XP (eXtraction and Processing)](https://help.ptsecurity.com/projects/siem/7.2/ru-RU/help/1566366731). При помощи данного расширения можно разрабатывать экспертизу для всех продуктов, которые поддерживают синтаксис языка XP:
  - [SOLDR](https://github.com/vxcontrol/soldr) 
  - [MaxPatrol SIEM](https://help.ptsecurity.com/projects/siem/7.2/ru-RU/help/709049099)
  - [PT XDR](https://help.ptsecurity.com/projects/xdr/3.2/ru-RU/help/3336136843)

Расширение обеспечивает [базовый функционал](#basic-and-full-functionality) на операционных системах Windows, Linux и MacOS и [полный функционал](#basic-and-full-functionality) - на Windows.

[Тут](https://github.com/Security-Experts-Community/vscode-xp/releases) можно скачать расширение в виде скомпилированного пакета. В дальшейшем планируем разместить расширение в [магазине расширений для VsCode](https://code.visualstudio.com/docs/editor/extension-marketplace).

Разработка проекта осуществляется в рамках открытого сообщества [Security Experts Community](https://github.com/Security-Experts-Community), вы можете внести [свой вклад](#for-developers) в развитие проекта.

Если возникают вопросы, то можно обращаться в [этот](https://t.me/MPSIEMChat) чат.

## Project repositories

Основной:
- GitHub: https://github.com/Security-Experts-Community/vscode-xp

Зеркала:
- Codeberg: https://codeberg.org/Security-Experts-Community/vscode-xp
- GitFlic: https://gitflic.ru/project/security-experts-community/vscode-xp

## Table of Contents

- [базовый и полный функционал](#basic-and-full-functionality);
- [типичные сценарии использования](#typical-use-cases);
- [настройка утилит для получения полного функционала](#configuring-tools).

## Basic and full functionality

Весь функционал расширения можно разделить на базовый и полный. Данное разделение возникло из-за того, что для использования всех функций необходимо скачать пакет утилит для работы с языком XP. После скачивания и установки расширения пользователю доступен только базовый функционал, а полный требует [настройки дополнительных утилит](#configuring-tools).

Под базовым функционалом расширения будем понимать следующий список функций:

- просмотр и редактирования нормализаций, агрегаций, корреляций, обогащений и табличных списков;
- автоматическое дополнение ключевых слов, функция языка, полей таксономии, типовых конструкций языка;
- статическое валидирование кода на типовые ошибки вайтлистинга (alert.key и макросы, имя правила и макросы);
- cоздание корреляции и обогащений через готовые шаблоны в зависимости от основных событий для детекта;
- просмотр, редактирование метаинформации нормализаций, корреляций, обогащений через контекстное меню;
- просмотр, редактирование локализаций нормализаций, корреляций через контекстное меню;
- просмотр, редактирование и создание интеграционных тестов для корреляций и обогащений;
- просмотр, редактирование и создание модульных тестов для корреляций и обогащений.

Полный функционал подразумевает базовый функционал и:

- запуск интеграционных, быстрых и модульных тестов для корреляций и обогащений;
- сборку графов нормализаций, табличных список;
- прогон сырых событий по всему графу корреляций;
- распаковка и упаковка пакетов экпертизы формата kb для последующего импорта.

## Typical use cases

В данном разделе представлены типичные кейсы по использованию расширения в разработке контента.

### Refinement of existing content

В этом случае предполагается, что в продукте уже имеется контент, который требует доработки. Для реализации данного сценария необходимо указать путь к утилите `kbtools` в расширении.

1. Экспортировать контент из MaxPatrol SIEM можно [следующим образом](https://help.ptsecurity.com/projects/siem/7.2/ru-RU/help/3320343819). Для работы сразу со всем контентом нужно экспортировать его полностью из продукта (TODO: дать более точные указания).
2. Далее в окне расширения на панели `Дерево контента` нужно нажать кнопку `Экспорт kb-файла`(TODO) и выбрать экспортированный файл и директорию для его распаковки.
3. После распаковки в дереве отобразиться штатная структура контента. Все правила хранятся в виде пакетов в поддиректории `packages`. Для сохранения изменений рекомендуется использовать систему контроля версии, например, git.
4. После доработки контента нажимаем на кнопку `Импорт kb-файла`(TODO) и выбираем путь к сохраняемого kb-файлу.
5. Для импорта kb-файла используем [данную инструкцию](https://help.ptsecurity.com/projects/siem/7.2/ru-RU/help/2061363851).

### Доработка существующего контента с тестированием

В этом случае предполагается, что в продукте уже имеется контент, который требует доработки. Для реализации данного сценария необходимо указать путь к утилите `kbtools.exe`, утилитам `siem-sdk` и `build-tools` в расширении. Порядок работы с контентом аналогичен работе [без тестов](#refinement-of-existing-content) за исключением использования [тестов](#tests) для проверки работоспособности правила.

### Создание структуры контента с нуля для замещения имеющегося в продукте

1. В окне расширения на панели `Дерево контента` нужно нажать кнопку `Создать базу знаний` (TODO) и директорию для её размещения.
2. После чего создается пустое дерево контента дя создания контента с нуля. **TODO** тут нужны: файл таксономии, tables_contract.yaml, макросы.

### Разработка правил с нуля без тестов

Наимение удобный способ использования расширения. В этом случае будет достаточно просто установить расширение на VsCode или VsCodium и приступать к [работе с контентом](#content-management).

## Content management

### Создание правила

1. Нажимаем на иконку расширения (Редактор контента).
2. На нужной директории в дереве контента вызываем контекстное меню.
3. В зависимости от типа создаваемого контента: `Cоздать корреляцию`, `Cоздать обогащение`.
4. Далее необходимо ввести название создаваемого правила и выбрать подходящий шаблон. Шаблон выбирается на основании предполагаемого основного события для детекта.
5. В зависимости от выбранного типа контента и шаблона у вас открывается файл для написания кода правила.

### Tests

После создания проекта правила, можно добавить интеграционные тесты.

### Прогон сырых событый по всему графу корреляций

Если у вас есть выборка сырых событий, то в расширении можно проверить какие корреляции из открытых отработают при попадании подобных событий в продукт.

## Configuring tools

Если у вас уже развернут Maxpatrol SIEM, тогда набор необходимых утилит можно найти по путям `C:\ProgramData\Positive Technologies\Knowledge Base\SiemSdks` и `C:\Program Files\Positive Technologies\Knowledge Base\Tools`. Их необходимо скопировать на компьютер с запущенным расширением и в настройках задать путь к данным утилитам.

## For developers

Если вы разработчик и желаете внести в свой вклад в разработку расширения, то ниже представлена информация для вас. У нас есть [беклог](#backlog), по которому планируется вести разработку.

### Build from sources

Для компиляции исходников необходимо:

1. Установить [VsCode](https://code.visualstudio.com/).
2. Установить [node.js](https://nodejs.org/en/download/).
3. Выгрузить код из рапозитория (`git clone`).
4. Выполнить команду `npm install` в корне проекта.

Для publish-а расширения нужно:

1. Единожды выполнить команду `npm install -g vsce`.
2. При каждом паблише запускать publish.py из корня проекта или выполнять команду `vsce package -o xpContentEditor.vsix`.

## Backlog

### Content Tree

1. Добавить возможность переименования директории в дереве контента.

### Rule code

1. Автодополнение локальных переменных, например, $auto_profile.
2. Разделить автодополнение функций по типам контента (нормализация, обогащение и корреляция).
3. Добавлять подсветку функций, ключевых слов и полей таксономии через код.
4. Автодополнение ТС из репы.

### WebView

1. Добавить возможность открыть несколько вебвьюшек одного типа для возможности копировать между ними данные.
2. Предлагать пользователю сохранить данные из WebView при открытии новой если они были изменены.
3. Ошибка двойного копирования текста при русской раскладке в WebView.
4. Обновление вьюшек при переключении ветки. Например, у тебя открыты модульные тесты правила. Ты сделал pull и тесты обновились, но у тебя открыты старые.
5. Подсветка ошибочных интеграционных тестов. Сейчас либо все подсвечиваются как зеленые, либо как нейтральные.

### Корректность кода (тесты, сборка графов и т.д.)

1. Добавить сборку локализаций при сборке графа для проверки их корректности.
2. Подсветка ошибочных интеграционных тестов.
3. Понизить замечание о разных ключах вайтлистинга до warning.
4. Выявление ошибок неявной конвертации ip-адреса (src.ip, event_src.ip и т.д.) к строке, результатом которого является пустая строка ("").
5. Можно по исправления в гите, например, нормализации, рекомендовать пересобрать графы.
6. Добавить тесты для нормализаций.
